### HotSpot虚拟机内的即时编译器

> 为何HotSpot虚拟机要使用解释器和编译器并存的架构？
>
> 为何HotSpot虚拟机要实现两个不同的即时编译器
>
> 程序何时使用解释器执行？何时使用编译器执行？
>
> 那些程序代码会被编译为本地代码？如何编译？
>
> 如何从外部观察即时编译器的编译过程和结果？

#### 1. 解释器与编译器

许多主流商用虚拟机都包含解释器和编译器，两者各有优势：当程序需要迅速启动和执行时，解释器可以首先发挥作用，省去编译时间，立即执行；在程序运行后，随着时间的推移，编译器逐渐发挥作用，把越来越多的代码编译成本地代码，获取更高的执行效率。

在HotSpot虚拟机中内置了两个即时编译器，Client Compiler和Server Compiler，简称为C1编译器和C2编译器（也叫Opto编译器）。HotSpot虚拟机中，默认采用解释器和其中一个编译器直接配合工作。HotSpot虚拟机会根据自身版本和宿主机器自动选择运行模式。

用户也可以使用`-client`，`-server`参数设置。也可以使用参数`-Xint`强制虚拟机运行与**解释模式(Interpreted Mode)**，全部代码都是用解释方法执行。  或者使用`-Xcomp`强制运行**编译模式(Compiled Mode)**，此时将优先采用编译方式执行程序，但解释器仍要在编译无法进行的时候介入执行过程。

为了在程序启动响应速度和运行效率之间达到平衡，HotSpot虚拟机还会逐渐启用**分层编译(Tiered Compilation)**的策略，会根据编译器编译、优化的规模与耗时，划分出不同的编译层次：

1. 第0层，程序解释执行，解释器不开启性能监控功能(Profiling)，可触发第1层编译
2. 第1层，也称C1编译，将字节码编译为本地代码，进行简单、可靠的优化，如有必要会加入性能监控的逻辑
3. 第2层(或以上)，也称C2编译，将字节码编译为本地代码，会开启一些编译耗时较长的优化，甚至会根据性能监控信息进行一些不可靠的激进优化。

#### 2. 编译对象和触发条件

在运行过程中会被即时编译器编译的热点代码有两类：

1. 被多次调用的方法
2. 被多次执行的循环体

对上面两类代码，编译器都会以整个方法为编译对象。这种编译方法因为编译发生在方法执行过程之中，因此也被称为栈上替换(On Stack Replacement，建成OSR编译)。

判断一段代码是不是热点代码的行为称为**热点探测(Hot Spot Detection)**，目前主要有两宗判定方式：

1. **基于采样的热点探测(Sample Based Hot Spot Detection)**：虚拟机会周期性地检查各个线程的栈顶，如果发现某个方法经常出现，那这个方法就是热点方法。
2. **基于计数器的热点探测(Counter Based Hot Spot Detection)**：虚拟机会为每个方法（甚至代码块）建立计数器，统计方法执行次数，如果执行次数超过一个阈值，就认为是热点方法。

HotSpot虚拟机采用的是第二种方法，它为每个方法准备了两类计数器：**方法调用计数器(Invocation Counter)**和**回边计数器(Back Edge Counter)**。

### 

